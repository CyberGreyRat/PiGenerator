<!DOCTYPE html>
<html lang="de">

<head>
    <meta charset="UTF-8">
    <title>Pi Flow mit Counter</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/decimal.js/10.4.3/decimal.min.js"></script>
    <style>
        body {
            background-color: #0d0d0d;
            color: #00ff41;
            font-family: 'Courier New', Courier, monospace;
            margin: 0;
            /* Wichtig: Platz oben lassen für den fixierten Header */
            padding-top: 80px;
            padding-left: 20px;
            padding-right: 20px;
            padding-bottom: 50px;
            word-break: break-all;
        }

        /* Der fixierte Balken oben */
        #header-bar {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 60px;
            background-color: #000;
            /* Schwarz, damit man den Text dahinter nicht sieht */
            border-bottom: 2px solid #00ff41;
            display: flex;
            align-items: center;
            padding-left: 20px;
            z-index: 100;
            /* Damit er immer über den Zahlen liegt */
            box-shadow: 0 0 15px rgba(0, 255, 65, 0.2);
        }

        /* Das Design für die Zahl selbst */
        #counter-label {
            font-size: 18px;
            margin-right: 15px;
            color: #aaa;
        }

        #digit-count {
            font-size: 32px;
            font-weight: bold;
            color: #fff;
            text-shadow: 0 0 10px #00ff41;
        }

        #pi-wrapper {
            font-size: 24px;
            line-height: 1.4;
        }

        #cursor {
            display: inline-block;
            width: 12px;
            height: 24px;
            background-color: #00ff41;
            animation: blink 1s step-end infinite;
            vertical-align: text-bottom;
        }

        @keyframes blink {

            0%,
            100% {
                opacity: 1;
            }

            50% {
                opacity: 0;
            }
        }

        /* Status unten rechts (optional, zur Kontrolle) */
        #debug-status {
            position: fixed;
            bottom: 5px;
            right: 10px;
            font-size: 12px;
            color: #444;
        }
    </style>
</head>

<body>

    <div id="header-bar">
        <span id="counter-label">ANZAHL NACHKOMMASTELLEN:</span>
        <span id="digit-count">0</span>
    </div>

    <div id="pi-wrapper">
        <span id="output"></span><span id="cursor"></span>
    </div>

    <div id="debug-status">System bereit...</div>

    <script>
        // --- EINSTELLUNGEN ---
        const ZIEL_GENAUIGKEIT = 10000;
        const SCHREIB_GESCHWINDIGKEIT = 50; // ms pro Zahl (ca. 20 Zahlen pro Sekunde)

        Decimal.set({ precision: ZIEL_GENAUIGKEIT + 50 });

        // Variablen
        let zahlenPuffer = [];
        let k = 0;
        let summe = new Decimal(0);
        let aktuellesPiString = "";

        // Zähler für die Anzeige oben
        let counterDisplayValue = 0;

        const sqrt2 = new Decimal(2).sqrt();
        const C = new Decimal(2).times(sqrt2).div(9801);

        // HTML Elemente holen
        const output = document.getElementById('output');
        const countDisplay = document.getElementById('digit-count');
        const debugStatus = document.getElementById('debug-status');

        function factorial(n) {
            let res = new Decimal(1);
            for (let i = 2; i <= n; i++) res = res.times(i);
            return res;
        }

        // --- 1. RECHNER ---
        function berechneNachschub() {
            if (aktuellesPiString.length >= ZIEL_GENAUIGKEIT) return;

            let k4 = 4 * k;
            let zaehler = factorial(k4).times(new Decimal(1103).plus(new Decimal(26390).times(k)));
            let nenner = factorial(k).pow(4).times(new Decimal(396).pow(k4));

            let term = zaehler.div(nenner);
            summe = summe.plus(term);

            let piWert = new Decimal(1).div(C.times(summe));
            let ganzerString = piWert.toString();

            let sichereLaenge = ganzerString.length - 15;

            if (sichereLaenge > aktuellesPiString.length) {
                let neuerSchnipsel = ganzerString.substring(aktuellesPiString.length, sichereLaenge);

                for (let char of neuerSchnipsel) {
                    if (char !== ".") {
                        zahlenPuffer.push(char);
                    } else {
                        if (aktuellesPiString.length === 0) zahlenPuffer.push("3", ".");
                    }
                }
                aktuellesPiString = ganzerString.substring(0, sichereLaenge);
            }
            k++;

            let pause = zahlenPuffer.length > 50 ? 200 : 1;
            setTimeout(berechneNachschub, pause);
        }

        // --- 2. SCHREIBER & ZÄHLER ---
        function schreibeZahl() {
            if (zahlenPuffer.length > 0) {
                let zeichen = zahlenPuffer.shift();

                output.innerText += zeichen;

                // --- NEUE LOGIK FÜR DEN ZÄHLER ---
                // Wir zählen nur hoch, wenn es NICHT "3" und NICHT "." ist.
                // Das Skript startet mit "3" und ".", danach kommen nur noch Ziffern.
                if (zeichen !== "3" && zeichen !== ".") {
                    counterDisplayValue++;
                    // Zahl oben aktualisieren
                    countDisplay.innerText = counterDisplayValue;
                }

                window.scrollTo(0, document.body.scrollHeight);
            }

            debugStatus.innerText = `Buffer: ${zahlenPuffer.length}`;
            setTimeout(schreibeZahl, SCHREIB_GESCHWINDIGKEIT);
        }

        // Start
        zahlenPuffer.push("3", ".");
        aktuellesPiString = "3.";

        berechneNachschub();
        schreibeZahl();

    </script>
</body>

</html>